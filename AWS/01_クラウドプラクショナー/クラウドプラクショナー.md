# AWSクラウドプラクショナー

## 概念

### AWS Well-Architected フレームワーク
信頼性、セキュリティ、効率、コスト効果が高いシステムを設計しクラウドで運用するために作られた、アーキテクチャのベストプラクティスです。


## セキュリティ

### AWSの責任共有モデル
- AWSはクラウド本体のセキュリティに責任がある。
- ユーザはクラウド上のデータに責任がある。
- マネージドサービスを使用することで、ユーザの責任範囲が小さくなる。
- EC2のようなアンマネージドサービスを使う場合、OSやWebサーバも含めてユーザの席にとなる。

### 管理プレーン

- APIキーはアクセスキーとシークレットキーからなる。
- ルートユーザのAPIキーは作らないこと。
- APIキーの代わりにIAMロールを使用する事。
- 権限の強いアカウントにはMFAを使用する事。


## AWF Artifact

- 様々な国際的な認証制度における証明を取得している。


## IAM (AWS Identity and Access Management)

- IAMグループ
    - IAMユーザをグループ化する
    - IAMポリシーを設定して、IAMグループに許可する操作を付与する。
- IAMユーザ
    - IAMユーザは1つ以上のIAMグループに所属する
    - IAMポリシーを設定して、IAMグループに許可する操作を付与する。
- IAMポリシー
    - 許可する操作をまとめたもの
    - jsonで定義される
- IAMロール
    - EC2やlambdaに割り当てる権限
    - IAMポリシーを付与する


## セキュリティグループ

- 一つ以上のインスタンスのトラフィックを制御する仮想ファイアウォール
- インバウンドはデフォルトではすべて禁止されている
- アウトバウンドはデフォルトではすべて許可されている
- インバウンドとアウトバウンドのルールを定義する
- 許可ルールの設定は可能
- 拒否ルールの設定は不可能


## AWS Shield

- DDOS攻撃に対応する機能
- StandardとAdbanceがあり、Standardは無償
- Standardはデフォルトで有効になっている
- Cloud Front、Route53、EC2で利用できる

## AWS WAF (AWS Web Application Firewall)

- Webアプリケーションに特化したファイアウォール
- Webアクセスコントロールリスト数による課金
- Webアクセスコントロール毎に追加するルール数による課金
- 受け取るWebリクエスト数に基づく課金
- CloudFront、Application Load Balancer、API Gatewayのいずれかに適用する

## Amazon Inspector

- EC2上にデプロイされたアプリケーションの脆弱性診断を自動で行う
- 有料です。

## AWS KMS (AWS Key Management Service)

- AWS上で暗号化キーを作成・管理し、幅広いAWSのサービスやアプリケーションでの利用を制御する機能
- 有料です。
- AWS CloudTrailと統合されていて、全てのキーの利用ログが記録される。


# AWSのテクノロジー 

## リージョン、アベイラビリティゾーン、エッジロケーション

- リージョンとあはサービスを提供する地域
- リージョン２つ以上のアベイラビリティゾーンで構成される
- アベイラビリティゾーンは複数のデータセンターで構成される
- データセンターの位置は非公開
- アベイラビリティゾーン同士は高速なプライベート光ファイバーネットワーキングで接続されている
- エッジロケーションはリージョンと違いところに数多く配置されている

# コンピューティング

## EC2 (Amazon Elastic Computer Cloud)

- いわゆる仮想サーバ
- 用途に合ったインスタンスタイプを選択する
- 必要なインスタンス数分を起動させる
- リージョン、ＯＳ、インスタンスタイプによって料金がことなる
- リージョン**外**にデータを転送する場合に料金がかかる
- つまり、インターネットへの転送と、別リージョンへの転送に料金がかかる
- インターネットからのインバウンドデータの転送には料金はかからない
- EC2のストレージであるEBS(Elastic Block Store)は、EC2インスタンスが起動していなくても料金がかかる
- EC2インスタンスへのアクセスはセキュリティグループで制御する
- EC2はキーペアを使ったログオン認証を使用するのが一般的である
- Linuxの場合は、SSHでキーペアを使ってログオンする
- Windowsの場合は、秘密キーからログオン用のパスワードを取得して、RDPでログオンする

## AMI(Amazon Machine Image)

- AMI(Amazon Machine Image)のイメージからEC2を起動する
- クイックスタートAMIは、Amazon Linux、Windows、Ubuntuなどが用意されている
- マイAMIは、お客様が用意するAMIである
- AWS Marketplaceは、パートナーベンダーが提供するソフトウェアやミドルウェアがインストールされている構成済みのAMIである
- コミュニティAMIは、一般公開されているAMIである

## EC2の料金プラン

- オンディマンドは、料金オプションを指定しないデフォルトの料金
- リザーブドインスタンスは、いわゆる年契約  
    1年または3年、全額前払い・一部前払い・前払い無し、スタンダードとコンパーチブルを選択する
- スポットインスタンスは、いわゆる時価  
    余っているインスタンスを安くりようできる
- Dedicated Hostsは、EC2が動作しているホストを占有する
- ハードウェア占有は、アカウント専用のハードウェアでEC2を動作させる

## ELB (Elastic Load Balancing)

- EC2の負荷分散をおこなう
- 3つのタイプがある。
    - Application Load Balancer - HTTP/HTTPSのリクエストを負荷分散する
    - Network Load Balancer - TCPレイヤでのリクエストを負荷分散する
    - Classic Load Balancer - 以前のタイプの負荷分散で、推奨として使わないこと
- ヘルスチェック機能があり、チェックNGのノードには負荷分散しないようにできる
- インターネット向けと内部向けに設定することができる
- インターネット向けはDNS名にパブリックIPアドレスが割り当てられる
- 内部向けはDNS名にプライベートIPアドレスが割り当てられる
- ELBは単一障害点にはならない
- クロスゾーンを指定すると、アベイラビリティゾーンを超えて負荷分散できる

## Auto Scaling

- 様々な契機でEC2のインスタンス数を増減させることができる
- 垂直スケーリングと水平スケーリングがあるが、水平スケーリングにすることが推奨される
- スケーリングの契機としては以下がある
    - ターゲットポリシー
        Auto ScalingグループのEC2の平均CPU使用率などを決めておくこと、AWSが自動的に最小数と最大数の間で適当なインスタンス数に調整する
    - シンプルポリシー
        Cloud Watchのアラームに基づいてスケーリングする
        クールダウン時間を設定しておき、立て続けにインスタンスが生成・終了されないようにする
    - ステップポリシー
        複数段階でインスタンスの生成・終了を行う
        ウォームアップ時間を設定することができる
    - スケジュール
        時刻を指定したスケーリングをおこなう
- 水平スケーリングを行ためには、インスタンスをステートレスにする
- ステートレスにする方法としては、AMIからイメージを取得した後、ユーザデータにより必要なソフトや設定を自動で行う方法がある
- ユーザデータでは、AWSのWebサービスを呼び出すことで、自サーバのIPアドレスやインスタンID等のメタデータを取得することができる

## Lambda

- ソースコードを用意するだけで、そのプログラムを実行することができるサービス
- プログラムを実行するための環境以下はすべて用意される
- C#, Java, Python, Node.js, PowerScript, Ruby, Goを使用することができる
- デフォルトで最大1000多重まで同時実行される
- 使用するメモリサイズを、128MBから3008MBの間で64MB刻みで指定する
- 最大のレスポンス時間は、15分である
- 他のAWSのイベントをトリガーとして呼び出される
    - S3にデータがアップロードされた
    - DynamoDBに新しいアイテムが書き込まれた
    - Auto Scalingのアクションが実行された 等...
- ソースコードはAWS CodeCommitなどのリポジトリで管理することができる

## ECS (Elastic Container Service)

- コンテナ管理を行うサービス

## Lightsail

- AWSが提供する仮想プライベートサーバ

## Batch

- フルマネージド型のバッチ処理実行環境のサービス

# ストレージ

## EBS (Elastic Block Store)

- EC2インスタンスのボリュームと指定使用
- アベイラビリティゾーン内の複数のサーバ間で自動的にリプリケートされる
- ボリュームタイプはIOPSで選択する
    - 汎用SSDは最大でも16,000 IOPS
    - プロビジョンドIOPS SSDは、最小のIOPSを指定できる
        最大IOPSは64000である
    - スループット最適化HDDは、低速だがコストが節約できる
    - Cold HDDはさらに低速である
- ボリュームタイプは変更する事ができる（オンラインでできる）
- ストレージ容量も変更する事ができる（オンラインでできる）
- スナップショットをとることでバックすることができる
    バックアップ先はS3である
- ボリュームの暗号化は追加の操作は必要ない

## インスタンスストア

- EC2のインスタンスのホストローカルのストレージを使用するのがインスタンストアになる
- EC2のインスタンスを停止するとデータが失われる

## S3 (Simple Storage Service)

- 無限のストレージ容量
- 高い耐久性（イレブンナイン）を実現
- 可用性は99.99%
- 1つのリージョン内で複数のアベイラビリティゾーンに分散・冗長化して保存される
- 1ファイルのサイズ上限は5TBまで
- インターネット経由でアクセス
- 作成した時点ではプライベートであるが、アクセス許可をすることでインターネット経由でアクセス可能となる
- バケットに対して、アクセスコントロールリストとバケットポリシーを設定する
- バケットに格納されるオブジェクトに対して、アクセスコントロールリストを設定する
- アクセスコントロールリストでは、特定のユーザに対する一覧・書き込み・読み取りの許可を設定
- バケットポリシーでは、特定のIPアドレスからの特定パス配下のオブジェクトへの操作許可を設定
- EC2からS3のオブジェクトにアクセスできるように、IAMポリシーを設定してIAMロールを割り当てることができる
- 通信中のデータを暗号化するには、HTTPSを選択する
  サーバ証明書にインストールは不要
- 保存データを暗号化する方法は
    - S3のキーを使ったサーバサイドの暗号化
    - KMSのキーを使ったサーバサイドまたはクライアント再度の暗号化
    - お客様独自のキーを使ったサーバサイドまたはクライアント再度の暗号化
- ストレージの料金は
    - ストレージクラス毎の料金
        - 標準
        - 低頻度アクセス
        - 1ゾーン低頻度アクセス
        - Amazon Glacier
    - リクエストの料金
    - データ転送の料金
        - リージョン外にデータを転送した場合にのみ発生する
        - 同じリージョンないでのデータ転送は無料
- ストレージクラスはライフサイクルポリシーで自動的に変更する事ができる

## EFS (Elastic File System)

- 複数のEC2インスタンスから共有利用できるファイルストレージサービス

## Storage Gateway

- オンプレミスアプリケーションとAWSのスレレージサービスを、シームレスに接続して利用することができるゲートウェイサービス

## Snowball

- 物理デバイスを使用して、ペタバイト級の大容量データを転送するサービス
- エクサバイト級のデータ転送には Snowmobileを使用する


# ネットワーク

## VPC (Virtual Private Cloud)

- 1つのリージョンに、複数のアベイラビリティゾーンをまたがった作成する
- CIDRでIPアドレス範囲を指定する
- 複数のサブネットを指定する
- サブネットはアベイラビリティゾーンを指定して作成する
- サブネットのIPアドレスは、ネットワークアドレス、ブロードキャストアドレス以外にも３つAWSが予約して使えないアドレスがある
- VPCに1つのインターネットゲートウェイを作成できる
- インターネットゲートウェイは、単一障害にならない
- インターネットゲートウェイは、VPCとパブリックインターネットを接続する
- サブネットの経路はルートテーブルで設定する
- セキュリティグループ（仮想ファイアウォール）を作成して、各インスタンスに対する送受信を制限する
- ネットワークACLはサブネットに対して設定する仮想ファイアウォール機能
- ネットワークACLはデフォルトで全て許可している
- 通常はネットワークACLはデフォルトのままでよい

## Cloud Front

- 世界150か所にある低レイテンシーでコンテンツを配信するCDNサービス
- キャッシュによる低レイテンシーを実現
- ユーザの近くから配信することで低レイテンシーを実現
- AWS Certificate Managerを利用することで、サーバ証明書を導入してSSL通信をサポートできる
- AWS Shield Standardは無料で利用することができる

## Route53

- DNSサービス
- 様々なルーティング機能
    - シンプルルーティング - 通常のAレコードと同じ
    - レイテンシーベースのルーティング
    - 加重ラウンドロビン
    - 複数値回答 - ランダムに返す
- ヘルスチェック機能

# データベースサービス

## RDS (Amazone Relational Database Service)

- DBMSまでは組み込んだマネージドサービスとして提供する
- 以下のDBMSが使用できる
    - Amazon Aurora
    - MySQL
    - PostgresSQL
    - MariaDB
    - Oracle
    - Microsoft SQL Server
- マネージドサービスのため、DBMS以下のメンテナンスはAWSが行う
- バックアップは、デフォルトで7日間の自動バックアップが定期用されている
- 自動バックアップを指定している期間であれば、特定の時刻のインスタンスに復元できる（ポイントリカバリ）
- 高可用性を備えており、単一障害点にならない
- マルチAZにすることで、アベイラビリティゾーン間で自動的にリプリケートが実行される

## DMS (Amazon Database Migration Service)

- データベース間でデータを移行するためのサービス
- オンプレミスのデータをRDSに移行する場合に使用できる

## DynamoDB

- NoSQL型のデータベース
- リージョンを選択する
- アベイラビリティゾーンは意識する必要がない
- データストアは複数のアベイラビリティゾーンで自動的に同期される
- データ容量は無制限

## Amazon Redshift

- 高速でシンプルなデータウェアハウス

## Amazon ElastiCache

- インメモリデータベースストア

## Amazon Neptune

- フルマネージドなグラフデータベース


# 管理サービス

## CloudWatch

- EC2インスタンスやRDSインスタンスの現在の状態をモニタリングするサービス
- AWSが管理している範囲の情報（標準メトリックス）は自動で収集されている
- 標準メトリックスの収集
- カスタムメトリックスの収集
    - メモリやアプリケーションの状態
    - PutMetricsData APIを使用してカスタムメトリックスとして書き込む
    - 書き込むプログラムはCloudWatchエージェントとして提供されていて、EC2にインストールして使用する
- ログの収集
    - CloudWatch Logsを使用する
    - CloudWatchエージェントにより、EC2の外部にログを出力して管理することができる
    - 文字列のフィルタリング結果をメトリックスとして扱うことができる
- アラーム
    各メトリックスから収集した情報に基づいてアラームを設定できる

## Trusted Advisor

- AWSアカウント環境の状態を自動的にチェックしてレポートする
    - コスト最適化
    - パフォーマンス
    - セキュリティ
    - フォールトトレランス
    - サービス制限
- サービス制限に近づいたサービスがアラート報告される

## CloudTrail

- AWSアカウント内のすべてのAPI呼び出しを記録する
- 監査や調査に利用する

## AWS Config

- AWSリソースの変更を自動記録する

## CloudFormation

- AWSの各リソースを含めた環境を自動作成・更新・管理する
- JSONやYAMLで記述したテンプレートから、同一のAWSの環境を自動で構築する

## Elastic Bean Stack

- Webアプリケーション環境をAWSに自動的に作成する

# 請求と料金


